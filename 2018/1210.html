<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>打包第三库那些事 | Saul Shen&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Keep simple, keep happy">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b6bfb1ac.css" as="style"><link rel="preload" href="/blog/assets/js/app.4fe4e32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.6fe09025.js" as="script"><link rel="preload" href="/blog/assets/js/22.b62e8f4a.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.530dcc5b.js"><link rel="prefetch" href="/blog/assets/js/11.4d53f011.js"><link rel="prefetch" href="/blog/assets/js/12.045882ce.js"><link rel="prefetch" href="/blog/assets/js/13.6645e80b.js"><link rel="prefetch" href="/blog/assets/js/14.d555f6c2.js"><link rel="prefetch" href="/blog/assets/js/15.4161ee70.js"><link rel="prefetch" href="/blog/assets/js/16.3672a1d7.js"><link rel="prefetch" href="/blog/assets/js/17.0127db4b.js"><link rel="prefetch" href="/blog/assets/js/18.291a8fd7.js"><link rel="prefetch" href="/blog/assets/js/19.57cab65a.js"><link rel="prefetch" href="/blog/assets/js/20.5789a416.js"><link rel="prefetch" href="/blog/assets/js/21.9266840a.js"><link rel="prefetch" href="/blog/assets/js/23.4a3ae109.js"><link rel="prefetch" href="/blog/assets/js/24.cea5c6c5.js"><link rel="prefetch" href="/blog/assets/js/25.1fca3e8c.js"><link rel="prefetch" href="/blog/assets/js/26.20a38b6d.js"><link rel="prefetch" href="/blog/assets/js/27.1b8292e7.js"><link rel="prefetch" href="/blog/assets/js/28.1d5e2edf.js"><link rel="prefetch" href="/blog/assets/js/29.e8700342.js"><link rel="prefetch" href="/blog/assets/js/3.3692318b.js"><link rel="prefetch" href="/blog/assets/js/30.9eca39c6.js"><link rel="prefetch" href="/blog/assets/js/4.82a020f0.js"><link rel="prefetch" href="/blog/assets/js/5.41beb069.js"><link rel="prefetch" href="/blog/assets/js/6.e8cd7694.js"><link rel="prefetch" href="/blog/assets/js/7.6b1babaf.js"><link rel="prefetch" href="/blog/assets/js/8.9eb0f85d.js"><link rel="prefetch" href="/blog/assets/js/9.d9d6b09e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b6bfb1ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Saul Shen's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="打包第三库那些事"><a href="#打包第三库那些事" class="header-anchor">#</a> 打包第三库那些事</h1> <blockquote><p><code>2018-12-10</code> by <code>Saul Shen</code></p></blockquote> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>一般来说，写完一个第三方库需要打包出三个文件夹的文件，对应三种不同模块类型</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># outputpath</span>
├── dist  <span class="token comment"># umd module</span>
├── es    <span class="token comment"># es module</span>
├── lib   <span class="token comment"># commonjs module</span>
</code></pre></div><h2 id="三个模块类型"><a href="#三个模块类型" class="header-anchor">#</a> <a href="https://juejin.im/post/5b7d2f45e51d4538826f4c28" target="_blank" rel="noopener noreferrer">三个模块类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <h3 id="umd"><a href="#umd" class="header-anchor">#</a> umd</h3> <ul><li><blockquote><p>UMD（Universal Module Definition）是 AMD 和 CommonJS 的糅合，跨平台的解决方案</p></blockquote></li> <li>UMD 打包出来的文件可以直接通过 script 插件 html 中使用</li> <li>我们的代码会被这样一段代码包裹起来</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackUniversalModuleDefinition</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> exports<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span> root<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> commonjs</h3> <ul><li><blockquote><p>CommonJS 模块是对象，是运行时加载，运行时才把模块挂载在 exports 之上（加载整个模块的所有），加载模块其实就是查找对象属性。</p></blockquote></li> <li><blockquote><p>导出使用 module.exports，也可以 exports。就是在此对象上挂属性。exports 指向 module.exports，即 exports= module.exports</p></blockquote></li> <li> 加载模块通过 require 关键字引用</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">sub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="es-module"><a href="#es-module" class="header-anchor">#</a> es module</h3> <ul><li><blockquote><p>ES Module 不是对象，是使用 export 显示指定输出，再通过 import 输入。此法为编译时加载，编译时遇到 import 就会生成一个只读引用。等到运行时就会根据此引用去被加载的模块取值。所以不会加载模块所有方法，仅取所需。</p></blockquote></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> m <span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> m <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'a.js'</span>
</code></pre></div><h3 id="why"><a href="#why" class="header-anchor">#</a> why</h3> <ul><li>umd 为了支持使用者通过各种不同的模块类型引用，包括通过 script 使用第三方库</li> <li>commonjs 支持使用者在 commonjs 模块类型下引用，而且可以部分使用第三方库，不会引入整个库</li> <li>es module 支持使用者在 es module 模块类型下引用, 如果使用者需要对第三方库再打包时，webpack、rollup 都对 es module 有特殊的优化，只打包使用到的方法</li></ul> <h2 id="使用-webpack-打包-umd-模块"><a href="#使用-webpack-打包-umd-模块" class="header-anchor">#</a> 使用 webpack 打包 umd 模块</h2> <p>如果使用 webpack 来打包 umd 文件，我们应该配置哪些选项</p> <h3 id="webpack-config"><a href="#webpack-config" class="header-anchor">#</a> webpack config</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'./dist'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'index.min.js'</span><span class="token punctuation">,</span>
    library<span class="token operator">:</span> <span class="token string">'MyLibrary'</span><span class="token punctuation">,</span>
    libraryExport<span class="token operator">:</span> <span class="token string">'default'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  externals<span class="token operator">:</span> <span class="token punctuation">{</span>
    react<span class="token operator">:</span> <span class="token punctuation">{</span>
      root<span class="token operator">:</span> <span class="token string">'React'</span><span class="token punctuation">,</span>
      commonjs2<span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
      commonjs<span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
      amd<span class="token operator">:</span> <span class="token string">'react'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>libraryTarget<br>
指定打包文件的模块类型</p></li> <li><p>library <br>
如果生成的输出文件，是在 HTML 页面中作为一个 script 标签引入，则变量 MyLibrary 将与入口文件的返回值绑定</p></li> <li><p>libraryExport <br>
默认 webpack 会把返回值绑定在 MyLibrary 的 default 属性下, 也就是<code>MyLibrary.default</code>才是我们模块的返回值。通过设置<code>libraryExport: 'default'</code>,起到<code>MyLibrary = MyLibrary.default</code>的效果， 不需要再通过 <code>default</code>属性去访问返回值</p></li> <li><p>externals <br>
为了缩小打包文件的体积，对引用到的其他库的文件，应该过滤掉，比如在这里引用到了 react，但实际上我们并不需要把 react 一起打包进去，我们可以通过一些方式来从 node_modules 文件夹中或者全局变量中访问到 react</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack 会判断不同的环境，并以不同的方式去访问react</span>
<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackUniversalModuleDefinition</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span>
    <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span>
    exports<span class="token punctuation">[</span><span class="token string">'MyLibrary'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span> root<span class="token punctuation">[</span><span class="token string">'MyLibrary'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>root<span class="token punctuation">[</span><span class="token string">'React'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>最后再配置一下 babel-loader，就能生成我们期望的 umd 文件了</p> <h2 id="使用-babel-打包-commonjs-模块"><a href="#使用-babel-打包-commonjs-模块" class="header-anchor">#</a> 使用 babel 打包 commonjs 模块</h2> <p>使用 babel 打包就很简单了， 先看一下 babelrc 怎么写</p> <h3 id="babelrc"><a href="#babelrc" class="header-anchor">#</a> babelrc</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'@babel/env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> loose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> modules<span class="token operator">:</span> <span class="token string">'cjs'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'@babel/preset-react'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useESModules<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="loose"><a href="#loose" class="header-anchor">#</a> <code>loose</code></h3> <p>一句话解释： true 的时候代码更现代化代码量少，false 更兼容代码量也更多</p> <h3 id="modules"><a href="#modules" class="header-anchor">#</a> <code>modules</code></h3> <p>设置使用不同的模块类型，commonjs 的话，就设置成'cjs'</p> <h3 id="transform-runtime"><a href="#transform-runtime" class="header-anchor">#</a> transform-runtime</h3> <p>babel 会给每个编译的文件插入一些辅助方法，如果文件一多的话，就出现了很多重复代码，这个插件会改为从第三方包引用辅助方法,
需要额外安装<code>@babel/runtime</code></p> <p>e.g.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/runtime/helpers/interopRequireDefault'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="build"><a href="#build" class="header-anchor">#</a> build</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>babel src --out-dir lib
</code></pre></div><h2 id="使用-babel-打包-es-module-模块"><a href="#使用-babel-打包-es-module-模块" class="header-anchor">#</a> 使用 babel 打包 ES Module 模块</h2> <p>只要把上面里所有 module 相关的设置改成 es module 就行了</p> <h3 id="babelrc-2"><a href="#babelrc-2" class="header-anchor">#</a> babelrc</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'@babel/env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> loose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> modules<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'@babel/preset-react'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useESModules<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="build-2"><a href="#build-2" class="header-anchor">#</a> build</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>babel src --out-dir es
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.4fe4e32b.js" defer></script><script src="/blog/assets/js/2.6fe09025.js" defer></script><script src="/blog/assets/js/22.b62e8f4a.js" defer></script>
  </body>
</html>
